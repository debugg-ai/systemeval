#!/bin/bash
# syseval - Terminal wrapper for systemeval pipeline evaluation
#
# This script allows running systemeval from outside Docker by wrapping
# the docker-compose exec command. Docker containers must be running.
#
# Usage:
#   syseval test --projects crochet-patterns --template pipeline_diagnostic
#   syseval list templates
#   syseval list adapters
#
# Environment:
#   SYSEVAL_COMPOSE_FILE - Path to docker-compose file (default: local.yml)
#   SYSEVAL_SERVICE - Docker service name (default: django)
#   SYSEVAL_WORKDIR - Working directory in container (default: /app)

set -e

# Configuration with defaults
COMPOSE_FILE="${SYSEVAL_COMPOSE_FILE:-local.yml}"
SERVICE="${SYSEVAL_SERVICE:-django}"
WORKDIR="${SYSEVAL_WORKDIR:-/app}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find the sentinal directory (where docker-compose files are)
find_sentinal_dir() {
    local dir="$PWD"

    # Walk up looking for local.yml
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/local.yml" ]]; then
            echo "$dir"
            return 0
        fi
        if [[ -f "$dir/sentinal/local.yml" ]]; then
            echo "$dir/sentinal"
            return 0
        fi
        dir="$(dirname "$dir")"
    done

    # Check common locations
    if [[ -f "$HOME/Documents/Github/debugg-ai/full-platform/sentinal/local.yml" ]]; then
        echo "$HOME/Documents/Github/debugg-ai/full-platform/sentinal"
        return 0
    fi

    return 1
}

# Check if Docker is running
check_docker() {
    if ! docker info &>/dev/null; then
        echo -e "${RED}Error: Docker is not running${NC}" >&2
        exit 1
    fi
}

# Check if the Django container is running
check_container() {
    local sentinal_dir="$1"

    cd "$sentinal_dir"

    if ! docker-compose -f "$COMPOSE_FILE" ps "$SERVICE" 2>/dev/null | grep -q "Up"; then
        echo -e "${YELLOW}Warning: Django container may not be running${NC}" >&2
        echo -e "${YELLOW}Start with: cd $sentinal_dir && docker-compose -f $COMPOSE_FILE up -d${NC}" >&2
    fi
}

# Ensure systemeval config exists in container
ensure_config() {
    local sentinal_dir="$1"

    cd "$sentinal_dir"

    # Check if config exists, if not create a default one
    docker-compose -f "$COMPOSE_FILE" exec -T "$SERVICE" bash -c "
        if [[ ! -f $WORKDIR/systemeval.yaml ]]; then
            cat > $WORKDIR/systemeval.yaml << 'EOF'
adapter: pipeline
project_root: \".\"
pipeline:
  timeout: 300
  poll_interval: 10
  skip_build: false
EOF
        fi
    " 2>/dev/null
}

# Main execution
main() {
    # Check for help flag
    if [[ "$1" == "-h" || "$1" == "--help" || -z "$1" ]]; then
        echo "syseval - SystemEval Pipeline Evaluation Wrapper"
        echo ""
        echo "Usage: syseval <command> [options]"
        echo ""
        echo "Commands:"
        echo "  test            Run pipeline evaluation"
        echo "  list adapters   List available adapters"
        echo "  list templates  List available output templates"
        echo ""
        echo "Test Options:"
        echo "  --projects NAME     Project slug(s) to evaluate"
        echo "  --template NAME     Output template (pipeline_diagnostic recommended)"
        echo "  --timeout SECONDS   Max wait time per project"
        echo "  --skip-build        Skip build, use existing containers"
        echo "  --verbose           Verbose output"
        echo "  --json              JSON output"
        echo ""
        echo "Examples:"
        echo "  syseval test --projects crochet-patterns --template pipeline_diagnostic"
        echo "  syseval test --projects crochet-patterns --skip-build --verbose"
        echo "  syseval list templates"
        echo ""
        echo "Environment:"
        echo "  SYSEVAL_COMPOSE_FILE  Docker compose file (default: local.yml)"
        echo "  SYSEVAL_SERVICE       Service name (default: django)"
        echo ""
        exit 0
    fi

    check_docker

    SENTINAL_DIR=$(find_sentinal_dir)
    if [[ -z "$SENTINAL_DIR" ]]; then
        echo -e "${RED}Error: Could not find sentinal directory with $COMPOSE_FILE${NC}" >&2
        echo "Set SYSEVAL_COMPOSE_FILE or run from within the project directory" >&2
        exit 1
    fi

    check_container "$SENTINAL_DIR"
    ensure_config "$SENTINAL_DIR"

    cd "$SENTINAL_DIR"

    # Build the systemeval command
    # Pass all arguments through, but add config if not specified
    local args=("$@")
    local has_config=false

    for arg in "${args[@]}"; do
        if [[ "$arg" == "--config"* ]]; then
            has_config=true
            break
        fi
    done

    # If running 'test' without explicit config, add default
    if [[ "${args[0]}" == "test" && "$has_config" == "false" ]]; then
        args=("${args[0]}" "--config=$WORKDIR/systemeval.yaml" "${args[@]:1}")
    fi

    # Execute in Docker
    echo -e "${BLUE}Running systemeval in Docker...${NC}" >&2
    docker-compose -f "$COMPOSE_FILE" exec -T "$SERVICE" bash -c "cd $WORKDIR && systemeval ${args[*]}" 2>&1 | grep -v "^INFO \|^WARNING pipeline_adapter\|^131 objects"

    exit_code=${PIPESTATUS[0]}

    if [[ $exit_code -eq 0 ]]; then
        echo -e "${GREEN}Pipeline evaluation completed successfully${NC}" >&2
    else
        echo -e "${RED}Pipeline evaluation failed (exit code: $exit_code)${NC}" >&2
    fi

    exit $exit_code
}

main "$@"
